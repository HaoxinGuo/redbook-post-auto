<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>生成带有文本和图片的图像</title>
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/twemoji@12.0.0/2/twemoji.min.js" crossorigin="anonymous"></script>
    <script src="emoji.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            background-color: #e0f7fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: row;
            width: 100%;
            max-width: 1200px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            background-color: #fff;
        }
        .left-panel, .right-panel {
            flex: 1;
            padding: 20px;
        }
        .left-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-right: 1px solid #ccc;
        }
        .right-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }
        h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }
        canvas {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            width: 267px;
            height: 357px;
        }
        button {
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }
        .add-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            padding: 0;
        }
        #output {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            animation: fadeIn 1s ease-in-out;
        }
        img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 10px;
            transition: transform 0.3s ease;
        }
        img:hover {
            transform: scale(1.05);
        }
        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }
        .input-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }
        .editable {
            border: 1px solid #ccc;
            min-height: 100px;
            padding: 10px;
            margin-bottom: 10px;
            overflow-y: auto;
        }
        .floating-toolbar {
            position: absolute;
            display: none;
            background-color: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .floating-toolbar button {
            margin-right: 5px;
            background: #f0f0f0;
            border: 1px solid #cccccc;
            border-radius: 3px;
            padding: 2px 5px;
            cursor: pointer;
        }
        .floating-toolbar button:hover {
            background: #e0e0e0;
        }
        .floating-toolbar input[type="color"] {
            width: 25px;
            height: 25px;
            padding: 0;
            border: 1px solid #cccccc;
            border-radius: 3px;
            cursor: pointer;
            vertical-align: middle;
        }
        select {
            margin-right: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        select:focus {
            border-color: #4CAF50;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .color-picker {
            margin-left: 10px;
            width: 30px;
            height: 30px;
            border: none;
            cursor: pointer;
        }
        .background-select {
            margin-bottom: 10px;
        }
        .font-toggle {
            margin-bottom: 10px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');
        @font-face {
            font-family: 'Virgil';
            src: url('https://excalidraw.com/Virgil.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Cascadia';
            src: url('https://excalidraw.com/Cascadia.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Chinese';
            src: url('https://file.yboshi.com/Chinese.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        #loadingIndicator {
            display: none;
            text-align: center;
            margin-top: 10px;
        }
        .color-picker-container {
            display: flex;
            align-items: center;
        }
        .color-picker-container button {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h1>生成带有文本和图片的图像</h1>
            <form id="inputForm">
                <!-- 添加背景选择 -->
                <div class="background-select">
                    <span>选择背景</span>
                    <label>
                        <input type="radio" name="background" value="grid" checked> 格子图
                    </label>
                    <label>
                        <input type="radio" name="background" value="memo"> 苹果备忘录
                    </label>
                </div>
                <!-- 添加字体切换按钮 -->
                <div class="font-toggle">
                    <span>选择字体样式：</span>
                    <label>
                        <input type="radio" name="fontStyle" value="normal" checked> 正常
                    </label>
                    <label>
                        <input type="radio" name="fontStyle" value="handwritten"> 手写
                    </label>
                </div>
                <button type="button" id="addInputButton" class="add-button">+</button>
                <button type="button" id="generateButton" disabled>生成图像</button>
                <div id="loadingIndicator">字体加载中，请稍候...</div>
            </form>
            <button id="downloadButton" style="display:none;">下载图像</button>
        </div>
        <div class="right-panel">
            <div id="output"></div>
        </div>
    </div>
    <div class="floating-toolbar" id="floatingToolbar">
        <button onclick="applyStyle('bold')">B</button>
        <button onclick="applyStyle('italic')"><i>I</i></button>
        <div class="color-picker-container">
            <input type="color" id="textColorPicker" title="文字颜色" />
            <button onclick="applyColor('foreColor')">确定</button>
        </div>
        <div class="color-picker-container">
            <input type="color" id="bgColorPicker" title="景颜色" />
            <button onclick="applyColor('hiliteColor')">确定</button>
        </div>
    </div>
    <script>
        const content = [];

        document.getElementById('addInputButton').addEventListener('click', () => {
            addInputGroup();
        });

        function addInputGroup(type = 'content', text = '', color = '#000000') {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';

            const textInput = document.createElement('div');
            textInput.className = 'editable';
            textInput.contentEditable = true;
            textInput.innerHTML = text;
            textInput.addEventListener('mouseup', showFloatingToolbar);
            textInput.addEventListener('input', updateContent);

            const textType = document.createElement('select');
            textType.className = 'textType';
            textType.innerHTML = `
                <option value="title">标题</option>
                <option value="content">内容</option>
            `;
            textType.value = type;

            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-button';
            deleteButton.innerHTML = '−';
            deleteButton.style.backgroundColor = 'red';
            deleteButton.style.color = 'white';
            deleteButton.style.borderRadius = '50%';
            deleteButton.style.width = '30px';
            deleteButton.style.height = '30px';
            deleteButton.style.marginLeft = '10px';
            deleteButton.style.display = 'flex';
            deleteButton.style.justifyContent = 'center';
            deleteButton.style.alignItems = 'center';
            deleteButton.style.fontSize = '20px';
            deleteButton.addEventListener('click', () => {
                if (document.querySelectorAll('.input-group').length > 1) {
                    inputGroup.remove();
                } else {
                    alert('至少保留一个输入框');
                }
            });

            const labelMap = {
                'title': '标题',
                'content': '内容',
            };

            const label = document.createElement('span');
            label.textContent = labelMap[type] + ': ';
            label.style.marginRight = '5px';

            inputGroup.appendChild(label);
            inputGroup.appendChild(textType);
            inputGroup.appendChild(textInput);
            inputGroup.appendChild(deleteButton);

            const inputForm = document.getElementById('inputForm');
            const addInputButton = document.getElementById('addInputButton');
            inputForm.insertBefore(inputGroup, addInputButton);
        }

        function showFloatingToolbar(e) {
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const toolbar = document.getElementById('floatingToolbar');
                toolbar.style.display = 'block';
                
                // 调整工具栏位置,确保不会超出视口
                const toolbarRect = toolbar.getBoundingClientRect();
                let left = rect.left + window.scrollX;
                let top = rect.top + window.scrollY - toolbarRect.height - 10;
                
                if (left + toolbarRect.width > window.innerWidth) {
                    left = window.innerWidth - toolbarRect.width - 10;
                }
                if (top < 0) {
                    top = rect.bottom + window.scrollY + 10;
                }
                
                toolbar.style.left = `${left}px`;
                toolbar.style.top = `${top}px`;
            }
        }

        function hideFloatingToolbar(e) {
            if (!e.target.closest('.editable') && !e.target.closest('.floating-toolbar')) {
                document.getElementById('floatingToolbar').style.display = 'none';
            }
        }

        document.addEventListener('mousedown', hideFloatingToolbar);

        document.getElementById('generateButton').addEventListener('click', async () => {
            const textInputs = document.querySelectorAll('.editable');
            const textTypes = document.querySelectorAll('.textType');

            content.length = 0; // 清空内容数组

            textInputs.forEach((textInput, index) => {
                const text = textInput.innerHTML;
                const type = textTypes[index].value;
                if (text.trim()) {
                    content.push({ type, text });
                }
            });

            if (content.length > 0) {
                const fontStyle = document.querySelector('input[name="fontStyle"]:checked').value;
                const pageHeight = fontStyle === 'handwritten' ? 580 : 520;
                const pages = paginateContent(content, pageHeight);
                await drawImageWithText(pages);
            } else {
                alert('请输入文本');
            }
        });

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        function isEmoji(str) {
            console.log('检查是否为 Emoji:', JSON.stringify(str));
            const result = EmojiUtil.containsEmoji(str);
            console.log('isEmoji 结果:', result);
            return result;
        }

        async function getEmojiImage(emoji) {
            console.log('开始为 Emoji 创建图像:', emoji);
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');
                ctx.font = '24px "Noto Color Emoji"';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(emoji, 16, 16);
                
                const img = new Image();
                img.onload = () => {
                    console.log('Emoji 图像加载成功:', emoji);
                    resolve(img);
                };
                img.onerror = (error) => {
                    console.error('Emoji 图像加载失败:', emoji, error);
                    resolve(null);
                };
                img.src = canvas.toDataURL();
                console.log('Emoji 图像 URL 创建完成');
            });
        }

        async function drawTextWithEmoji(ctx, textObject, x, y, maxWidth, maxHeight) {
            const { text, type } = textObject;
            const isTitle = type === 'title';
            const fontStyle = document.querySelector('input[name="fontStyle"]:checked').value;
            maxWidth -= 20; // 增加右边距

            const regularFont = isTitle ? '20px "Microsoft YaHei", "Noto Color Emoji"' : '12px "Microsoft YaHei", "Noto Color Emoji"';
            const handwrittenFont = isTitle ? '20px Chinese, Virgil, "Noto Color Emoji"' : '12px Chinese, Virgil, "Noto Color Emoji"';
            ctx.font = fontStyle === 'handwritten' ? handwrittenFont : regularFont;

            let currentY = y;
            let lineHeight = isTitle ? 30 : 18;
            const initialX = x; // 保存初始 x 坐标

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;

            async function processNode(node, startX, inheritedStyle = {}) {
                let style = { ...inheritedStyle };
                let currentX = startX;
                let line = ''; // 在这里定义 line 变量

                if (node.nodeType === Node.TEXT_NODE) {
                    let text = node.textContent;
                    let i = 0;
                    while (i < text.length) {
                        let char = text[i];
                        let nextChar = text[i + 1] || '';
                        let combinedChar = char + nextChar;

                        if (isEmoji(combinedChar)) {
                            if (line) {
                                currentX = await drawTextSegment(line, currentX, currentY, style);
                                line = '';
                            }
                            const emojiWidth = lineHeight * 1.2;
                            if (currentX + emojiWidth > initialX + maxWidth) {
                                currentY += lineHeight;
                                currentX = initialX;
                            }
                            const emojiImg = await getEmojiImage(combinedChar);
                            if (emojiImg) {
                                ctx.drawImage(emojiImg, 
                                    currentX, 
                                    currentY - lineHeight * 0.8, 
                                    lineHeight - 2, 
                                    lineHeight - 2
                                );
                                currentX += emojiWidth;
                            } else {
                                currentX = await drawTextSegment(combinedChar, currentX, currentY, style);
                            }
                            i += 2; // 跳过下一个字符，因为我们已经处理了组合字符
                        } else {
                            let testLine = line + char;
                            let testWidth = ctx.measureText(testLine).width;

                            if (currentX + testWidth > initialX + maxWidth) {
                                if (line) {
                                    currentX = await drawTextSegment(line, currentX, currentY, style);
                                    currentY += lineHeight;
                                    currentX = initialX;
                                    line = char;
                                } else {
                                    currentX = await drawTextSegment(char, currentX, currentY, style);
                                    currentY += lineHeight;
                                    currentX = initialX;
                                }
                            } else {
                                line += char;
                            }
                            i++;
                        }
                    }
                    if (line) {
                        currentX = await drawTextSegment(line, currentX, currentY, style);
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    if (node.style.color) style.color = node.style.color;
                    if (node.style.backgroundColor) style.backgroundColor = node.style.backgroundColor;
                    if (node.style.fontWeight === 'bold') style.font = `bold ${ctx.font}`;
                    if (node.style.fontStyle === 'italic') style.font = `italic ${ctx.font}`;
                    if (node.tagName.toLowerCase() === 'font' && node.getAttribute('color')) {
                        style.color = node.getAttribute('color');
                    }

                    for (let childNode of node.childNodes) {
                        currentX = await processNode(childNode, currentX, style);
                    }
                }

                return currentX;
            }

            async function drawTextSegment(text, x, y, style) {
                const originalX = x; // 保存原始的 x 坐标
                if (style.backgroundColor) {
                    ctx.save();
                    ctx.fillStyle = style.backgroundColor;
                    const bgWidth = ctx.measureText(text).width;
                    ctx.fillRect(x, y - lineHeight * 0.8, bgWidth, lineHeight);
                    ctx.restore();
                }
                ctx.fillStyle = style.color || 'black';
                ctx.font = style.font || ctx.font;
                ctx.fillText(text, x, y);
                return originalX + ctx.measureText(text).width; // 使用原始的 x 坐标计算新的位置
            }

            await processNode(tempDiv, initialX);

            return { y: currentY + lineHeight };
        }

        function calculateTextHeight(ctx, text, maxWidth, isTitle) {
            maxWidth -= 20; // 减少右边距

            const lineHeight = isTitle ? 30 : 18;
            let totalHeight = 0;
            let totalLines = 0;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;

            function processNode(node, style = {}) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const words = node.textContent.split('');
                    let line = '';

                    for (let word of words) {
                        const testLine = line + word;
                        ctx.font = style.font || ctx.font;
                        const metrics = ctx.measureText(testLine);
                        const testWidth = metrics.width;

                        if (testWidth > maxWidth && line !== '') {
                            totalHeight += lineHeight;
                            totalLines += 1;
                            line = word;
                        } else {
                            line = testLine;
                        }
                    }
                    if (line !== '') {
                        totalHeight += lineHeight;
                        totalLines += 1;
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    let newStyle = { ...style };
                    if (node.style.color) newStyle.color = node.style.color;
                    if (node.style.fontWeight === 'bold') newStyle.font = `bold ${ctx.font}`;
                    if (node.style.fontStyle === 'italic') newStyle.font = `italic ${ctx.font}`;
                    if (node.style.backgroundColor) newStyle.backgroundColor = node.style.backgroundColor;
                    if (node.tagName.toLowerCase() === 'font' && node.getAttribute('color')) {
                        newStyle.color = node.getAttribute('color');
                    }

                    for (let childNode of node.childNodes) {
                        processNode(childNode, newStyle);
                    }
                }
            }

            processNode(tempDiv);

            // 为样式复杂的文本添加少量额外高度
            totalHeight += Math.ceil(totalLines / 4) * lineHeight;

            console.log(`计算高度: 文本="${text.substring(0, 20)}...", 总行数=${totalLines}, 总高度=${totalHeight}`);

            return { totalHeight, totalLines };
        }

        function paginateContent(content, maxHeight) {
            console.log('开始分页，最大高度:', maxHeight);
            const pages = [];
            let currentPage = [];
            let currentHeight = 0;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.font = '12px Microsoft YaHei';

            // 设置实际可用高度，留出一些边距
            const usableHeight = maxHeight ; // 上下各留出 20px 的边距

            content.forEach((item, index) => {
                console.log(`处理第 ${index + 1} 个项目:`, item);
                let itemHeight = 0;
                if (item.type === 'title') {
                    ctx.font = '20px Microsoft YaHei';
                    const { totalHeight } = calculateTextHeight(ctx, item.text, 267 - 40, true);
                    itemHeight = totalHeight + 10; // 增加标题底部间距
                    console.log('标题高度:', itemHeight);
                } else if (item.type === 'content') {
                    ctx.font = '12px Microsoft YaHei';
                    const { totalHeight } = calculateTextHeight(ctx, item.text, 267 - 40, false);
                    itemHeight = totalHeight + 5; // 减内容之间的间距
                    console.log('内容高度:', itemHeight);
                } else {
                    console.error('未知的项类型:', item.type);
                    return;
                }

                console.log('当前页高度:', currentHeight, '项目高度:', itemHeight, '总高度:', currentHeight + itemHeight);

                // 如果当前页剩余空间不足，开始新的一页
                if (currentHeight + itemHeight > usableHeight) {
                    console.log('开始新页面，前页内容:', currentPage);
                    pages.push(currentPage);
                    currentPage = [];
                    currentHeight = 0;
                }
                currentPage.push(item);
                currentHeight += itemHeight;
                console.log('更新后的当前页高度:', currentHeight);
            });

            if (currentPage.length > 0) {
                console.log('添加最后一页，内容:', currentPage);
                pages.push(currentPage);
            }

            console.log('分页完成，总页数:', pages.length);
            return pages;
        }
        

        async function drawImageWithText(pages) {
            console.log('开始绘制图像,总页数:', pages.length);

            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = '';

            // 获取选中的背景
            const selectedBackground = document.querySelector('input[name="background"]:checked').value;

            for (const [pageIndex, page] of pages.entries()) {
                console.log(`绘制第 ${pageIndex + 1} 页`);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const scale = 2; // 增加分辨率

                canvas.width = 267 * scale;
                canvas.height = 357 * scale;
                ctx.scale(scale, scale);

                try {
                    // 根据选加载不同的背景图片
                    const backgroundUrl = selectedBackground === 'grid' 
                        ? 'https://file.yboshi.com/%E6%A0%BC%E5%AD%90%E5%9B%BE.png'
                        : 'https://file.yboshi.com/%E5%B0%8F%E7%BA%A2%E4%B9%A6%E8%83%8C%E6%99%AF.png';
                    const background = await loadImage(backgroundUrl);
                    ctx.drawImage(background, 0, 0, canvas.width / scale, canvas.height / scale);

                    let y = 20; // 从顶部 20px 开始绘制

                    ctx.font = '20px Microsoft YaHei';
                    y += 35;

                    for (const item of page) {
                        console.log(`绘制项:`, item);

                        if (!item || typeof item !== 'object') {
                            console.error('无效的项:', item);
                            continue;
                        }

                        const fontStyle = document.querySelector('input[name="fontStyle"]:checked').value;
                        if (item.type === 'title') {
                            ctx.font = fontStyle === 'handwritten' ? '20px Chinese, Virgil, "Noto Color Emoji"' : '20px "Microsoft YaHei", "Noto Color Emoji"';
                        } else if (item.type === 'content') {
                            ctx.font = fontStyle === 'handwritten' ? '12px Chinese, Virgil, "Noto Color Emoji"' : '12px "Microsoft YaHei", "Noto Color Emoji"';
                        } else {
                            console.error('未知的项类型:', item.type);
                            continue;
                        }

                        // 计算文本长度
                        const textWidth = ctx.measureText(item.text).width;
                        console.log(`项类型: ${item.type}, 文本长度: ${textWidth}px`);

                        let xPosition;
                        if (item.type === 'title') {
                            // 计标题的 x 坐标，使其居中
                            xPosition = (canvas.width / scale - textWidth) / 2;
                            ctx.textAlign = 'left'; // 改为左对齐，因为我们手动计算了居中位置
                            const result = await drawTextWithEmoji(ctx, item, xPosition, y, (canvas.width - 40) / scale, canvas.height);
                            y = result.y;
                            y += 5; // 减少标题底部间距
                        } else if (item.type === 'content') {
                            // 设置内容的 x 坐标 (左边距 20px)
                            xPosition = 20;
                            ctx.textAlign = 'left';
                            const result = await drawTextWithEmoji(ctx, item, xPosition, y, (canvas.width - 40) / scale, canvas.height);
                            y = result.y;
                            y += 5; // 减少内容之间的间距
                        }
                    }

                    const img = new Image();
                    img.src = canvas.toDataURL();
                    img.style.width = '267px'; // 保持页面上展示的大小不变
                    img.style.height = '357px'; // 保持面上展示的大小不变
                    outputDiv.appendChild(img);

                } catch (error) {
                    console.error('加载图像出错:', error);
                }
            }

            const downloadButton = document.getElementById('downloadButton');
            downloadButton.style.display = 'block';
            downloadButton.onclick = () => {
                pages.forEach((page, index) => {
                    const link = document.createElement('a');
                    link.href = document.querySelectorAll('#output img')[index].src;
                    link.download = `生成图像_${index + 1}.png`;
                    link.click();
                });
            };
        }

        // 获取 URL 参数
        function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        // 填充表单
        window.onload = () => {
            const params = getQueryParams();
            const inputForm = document.getElementById('inputForm');
            
            // 移除所有现有的输入组
            const existingInputGroups = inputForm.querySelectorAll('.input-group');
            existingInputGroups.forEach(group => group.remove());

            // 添加输入框
            if (!params.title && !params.content) {
                addInputGroup();
            } else {
                if (params.title) {
                    addInputGroup('title', params.title, '#000000');
                }
                if (params.content) {
                    const contentArray = JSON.parse(params.content);
                    contentArray.forEach(content => {
                        addInputGroup('content', content, '#000000');
                    });
                }
            }

            // 如果没有添加任何输入框，则添加一个默认的空白输入框
            if (inputForm.querySelectorAll('.input-group').length === 0) {
                addInputGroup();
            }
        };

        WebFont.load({
            custom: {
                families: ['Virgil', 'Cascadia', 'Chinese', 'Noto Color Emoji'],
                urls: [
                    'https://excalidraw.com/Virgil.woff2',
                    'https://excalidraw.com/Cascadia.woff2',
                    'https://file.yboshi.com/Chinese.woff2',
                    'https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap'
                ]
            },
            active: function() {
                console.log('所有字体已加载');
                document.getElementById('generateButton').disabled = false;
                document.getElementById('loadingIndicator').style.display = 'none';
            },
            loading: function() {
                console.log('字体加载中');
                document.getElementById('loadingIndicator').style.display = 'block';
            }
        });

        function applyStyle(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('floatingToolbar').style.display = 'none';
        }

        function applyColor(command) {
            const colorPicker = command === 'foreColor' ? document.getElementById('textColorPicker') : document.getElementById('bgColorPicker');
            applyStyle(command, colorPicker.value);
        }

        function updateContent() {
            const textInputs = document.querySelectorAll('.editable');
            const textTypes = document.querySelectorAll('.textType');

            content.length = 0; // 清空内容数组

            textInputs.forEach((textInput, index) => {
                const text = textInput.innerHTML;
                const type = textTypes[index].value;
                if (text.trim()) {
                    const computedStyle = window.getComputedStyle(textInput);
                    const style = {
                        color: computedStyle.color,
                        backgroundColor: computedStyle.backgroundColor
                    };
                    content.push({ type, text, style });
                }
            });

            console.log('Updated content:', content);
        }
    </script>
</body>
</html>